<div class="home-container">
    <header class="app-header">
        <div class="logo">MyPics</div>

        <div class="search-bar">
            <i class="pi pi-search search-icon"></i>
            <input type="text" [formControl]="searchControl" placeholder="Search photos..." class="search-input" />
        </div>

        <div class="actions">
            <select [formControl]="sortControl" class="sort-select">
                <option *ngFor="let option of sortOptions" [value]="option.value">{{ option.label }}</option>
            </select>

            <button class="btn-theme" (click)="themeService.toggleTheme()" title="Toggle Theme">
                <i class="pi" [ngClass]="themeService.theme() === 'light' ? 'pi-moon' : 'pi-sun'"></i>
            </button>
            <label class="btn-upload">
                <input type="file" multiple accept=".jpg,.jpeg,.png" (change)="onFileSelected($event)" hidden />
                <span>+ Upload Photos</span>
            </label>
            <div class="user-profile" *ngIf="user" (click)="toggleUserPopover($event)">
                <img [src]="user?.userLogoURL || 'assets/default-avatar.png'" [alt]="user?.name" class="avatar-img"
                    (error)="user.userLogoURL = null" />
                <div class="user-popover" *ngIf="showUserPopover" (click)="$event.stopPropagation()">
                    <div class="popover-header">
                        <div class="user-info">
                            <p class="user-name">{{ user?.name }}</p>
                            <p class="user-email">{{ user?.email }}</p>
                        </div>
                    </div>
                    <div class="popover-footer">
                        <button class="btn-logout-popover" (click)="logout()">
                            <i class="pi pi-sign-out"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <button class="btn-logout" *ngIf="!user" (click)="logout()">Logout</button>
        </div>
    </header>

    <main class="gallery-content">
        <!-- Loading State -->
        <div *ngIf="loading$ | async" class="loading-bar">
            <div class="indeterminate-bar"></div>
        </div>

        <ng-container *ngIf="files$ | async as files; else loadingState">
            <div class="masonry-grid" *ngIf="files.length > 0; else noFiles">
                <div class="masonry-item" *ngFor="let file of files; let i = index">
                    <div class="image-card" (click)="openGallery(i)">
                        <img [src]="file.url || file.filePath" [alt]="file.originalName" loading="lazy" />
                        <div class="overlay">
                            <button class="btn-delete" (click)="deleteFile(file.id, $event)" title="Delete Image">
                                &times;
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <ng-template #noFiles>
                <div class="empty-state">
                    <i class="pi pi-image" style="font-size: 2rem; margin-bottom: 1rem; color: var(--text-muted)"></i>
                    <p>No photos found matching your criteria.</p>
                </div>
            </ng-template>
        </ng-container>

        <ng-template #loadingState>
            <!-- Ideally handled by the loading$ overlay or skeleton, but keeping a fallback -->
        </ng-template>

        <p-galleria [(visible)]="displayGalleria" [value]="(files$ | async) || []" [numVisible]="5" [fullScreen]="true"
            [containerStyle]="{ 'max-width': '640px' }" [(activeIndex)]="selectedImageIndex"
            (activeIndexChange)="onActiveIndexChange($event)">
            <ng-template #item let-item>
                <img [src]="item.url" style="
                    width: 100%;
                    height: 100%;
                    max-height: 70vh;
                    object-fit: contain;
                " />
            </ng-template>

            <ng-template #thumbnail let-item>
                <img [src]="item.url" style="width: 60px; height: 60px; object-fit: cover;" />
            </ng-template>

        </p-galleria>
    </main>
</div>